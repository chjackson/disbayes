---
title: "Bayesian estimation of chronic disease epidemiology from incomplete data"
author: Chris Jackson <chris.jackson@mrc-bsu.cam.ac.uk>
output: 
  html_document:
    number_sections: true
bibliography: disbayes.bib
---

This document illustrates how case fatality can be estimated given incidence and mortality, using Bayesian modelling. 

This also serves to illustrate a general approach for estimating quantities describing disease epidemiology, based on indirect / incomplete data or multiple data sources.

The method is implemented in freely-available software, and the code can be adapted easily to novel situations. 

# Theoretical disease model 

We represent a disease as a continuous-time, multi-state process with three states: 

1. disease-free
2. disease
3. dead from the disease.

If we assume that mortality from other causes is independent of disease status, deaths from other causes are uninformative and can be ignored.   Assume also for simplicity that remission from the disease is not possible (though the framework illustrated here is easily extensible to handle remission). 

The disease process is then fully defined by the 

* disease incidence $i(t)$, and the 

* case fatality rate $f(t)$,

which are both assumed to depend on age $t$.  Assume further that these rates are constant within integer years of age $a$, so they can be written $i_a$, $f_a$.

From these we can determine the _transition probability matrix_ $P_a$, whose $r,s$ entry $P_{ars}$ is the probability that a person is in state $s$ at age $a+1$ given they are in state $r$ at age $a$. The matrix $P_a$ is defined as a function of $i_a$ and $f_a$, which is the solution to a differential equation, and is written out explicitly in the DisMod II paper (@dismod2). 

Further, let $S_a$ be the "state occupancy probabilities", or the proportion of individuals in a hypothetical birth cohort (of infinite size) who are in each state at age $a$.  This is a row vector with three elements $S_{ar}$, one for each state $r$.  Assume everyone is disease-free at age 0.  The state occupancy probabilities at each subsequent age $a+1$ are then determined by mutiplying by the transition probability matrix: 

$$ S_{a+1} = S_a P_a $$ 

The prevalence of disease (among people who are alive) at each age $a$ is then obtained as $pr_a = S_{a2} / (S_{a1} + S_{a2})$. 

The disease-specific mortality rate at age $a$, or the probability that a person alive at age $a$ dies from the disease before age $a+1$, can also be expressed in terms of the disease prevalence at age $a$ and the transition probabilities between ages $a$ and $a+1$, as 

$$ dm_a = P_{a23} pr_a + P_{a13} (1 - pr_a) $$


# Bayesian approach to estimating the model from data

Data are observed which give information about some, but not all, of the parameters in the theoretical disease model.   The form of the data available may be different in each application.  We then wish to estimate any remaining unknown parameters.   The Bayesian approach to estimating these unknowns can be described as four steps:

1. write down a theoretical model for underlying disease progression (as done above)

2. write down a statistical model for the observed data given the parameters of the underlying disease model.  An example of this is illustrated below.

3. write down prior distributions for the unknowns.  These may express prior ignorance, as in the example below.

4. compute the (unique) posterior distribution of the unknown parameters in the joint model, given the observed data.  

This approach is used in the DisMod-MR software, as explained by @flaxman2015, however the software itself is undocumented and not fully published.  The older (published) DisMod II (@dismod2) used an ad-hoc optimisation approach to estimate parameters. 

Advantages of the Bayesian method include 

* the ease of including multiple sources of direct/indirect data.  This is enabled by the computational methods and available software for Bayesian modelling, illustrated below.   This allows the approach to generalise to settings with different forms of data available.  In contrast, DisMod II only allows limited forms of data. 

* uncertainty about any quantity is quantified automatically through the posterior distribution, given the data, model assumptions and prior distributions supplied.

The use of general-purpose free software for this computation is described below.



# Example: IHD for men in Greater London 

The following data are given in the R data frame `ihdlondon` supplied here. 

* `inc` incidence of IHD by age

* `mort` IHD-specific mortality by age

and we wish to estimate case fatality by age, given these inputs.  The first few rows of the full data frame are shown here.  The estimates of case fatality from DisMod II are given in the variable `cfout`.  The other variables are explained below.

```{r}
load(file="ihdlondon.rda")
head(ihdlondon)
```

Note that the "data" `inc` and `mort` are themselves estimates, based on underlying data from a finite population that are not given.  In the Bayesian approach, we can acknowledge that these quantities, along with the case fatality, are unknowns.   We illustrate this approach.  For simplicity, suppose that 

* the incidence $i_a$ is known and fixed at the quantities supplied in `inc`, but 

* the disease-specific mortalities $dm_a$ are not exactly equal to `mort`, but have been estimated in terms of counts of individuals $n_a$ alive at age $a$ and the corresponding number $r_a$ who die of IHD before age $a+1$.

In this example, $n_a$ and $r_a$ were not provided in the original data source, but can be roughly recreated, as follows.  We were given population counts for five-year age groups, thus we obtain approximate one-year population counts $n_a$ by dividing these values by 5 (`pop` in the R data).  The number of IHD deaths $r_a$ (`ndieddis` in the R data) is then approximately reconstructed by multiplying $n_a$ by the IHD-specific mortality rates supplied in the spreadsheet.

The four steps of the Bayesian modelling process are then implemented as follows:

1. write down the theoretical disease model, as given above

2. write down the statistical model for the data.  This is $r_a \sim ~ Binomial(n_a, dm_a)$, that is, $r_a$ is assumed to have arisen from a Binomial distribution with denominator $n_a$ and probability $dm_a$. The disease-specific mortality $dm_a$ is a deterministic function of the incidences and case fatalities $\{i_j,f_j\}$ for ages $j$ up to $a$, as described in the theoretical disease model. 

3. define prior distributions for the unknown parameters.  For example, for each case fatality rate $f_a$, we assume a uniform distribution between 0 and 0.1.  Sensitivity to this should be assessed.  With enough data, the prior distribution will not matter.

4. compute the posterior distribution $p(\theta | \mathbf{y})$ for parameters $\theta = \{f_a\}$ given data $\mathbf{y} = \{i_a, r_a, n_a\}$

Note also that estimates of prevalence are available in the source data, though these are also implicitly based on observing the number of people with IHD in a population.  If the numerators $n^{(prev)}_a$ and denominator $r^{(prev)}_a$ corresponding to each age $a$ prevalence were known, they could be included in the model in the same way, as $r^{(prev)}_a \sim ~ Binomial(n^{(prev)}_a, pr_a)$.  This acknowledges that the prevalence is an uncertain estimate, rather than a constant.   The numerators and denominators are not provided in the source data, so we assume values for the denominators, given in the variable `prevdenom`.  The corresponding numerators `prevn` are then obtained by multiplying `prevdenom` by the provided prevalence estimates, and rounding to the nearest integer.


# Fitting Bayesian models with the Stan software

The Stan software ([mc-stan.org](http://mc-stan.org)) allows any Bayesian model to be written down in the Stan language.  The software then enables a sample from the posterior distribution to be drawn, using Hamiltonian Monte Carlo sampling.   It has an R interface, through the `rstan` package.  Its use is demonstrated briefly here.

First load Stan and its R interface, after installing it into R if necessary with `install.packages("rstan")`. 
```{r,message=FALSE}
library(rstan)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
```
In this example, the theoretical disease model, statistical model and priors are written down in Stan language in the file [gbdcf-unsmoothed.stan](https://github.com/chjackson/disbayes/blob/master/gbdcf-unsmoothed.stan).

The data $\mathbf{y} = \{i_a, r_a, n_a\}$ are supplied in the `ihdlondon` data frame.  These are converted in to the required format for Stan, and initial values are defined for 4 parallel MCMC simulations.   Finally, the simulation is run with `stan()`, which should take less than a minute. 
```{r, cache=TRUE, warning=FALSE, message=FALSE}
datstan <- c(as.list(ihdlondon), nage=nrow(ihdlondon))
inits <- list(
    list(cf=rep(0.0101, datstan$nage)),
    list(cf=rep(0.0201, datstan$nage)),
    list(cf=rep(0.0056, datstan$nage)),
    list(cf=rep(0.0071, datstan$nage))
)
gbdcf <- stan("gbdcf-unsmoothed.stan", data=datstan, init=inits)
```

We check the MCMC simulations have converged, by examining the "trace plot" of the simulation progress for six selected parameters. The four simulated chains should mix together and look like white noise.
```{r}
traceplot(gbdcf, pars=paste0("cf[", 60:65, "]"))
```


# IHD example: Results 

The summary statistics (posterior median, 95% credible intervals, etc) are extracted from the fitted model.
```{r}
summ <- summary(gbdcf)$summary
```

The summary statistics for case fatality are extracted and plotted in R, and the corresponding estimates from DisMod II are overlaid. 

```{r}
cfpars <- paste0("cf[",1:100,"]")
cf <- summ[cfpars,]
plot(1:100, cf[,"50%"], ylim=c(0, 0.1), pch=19, ylab="Estimated case fatality rate", xlab="Age")
title("Estimating case fatality given mortality and incidence data")
title("IHD, Greater London (?year?)", line=0.5)
segments(1:100, cf[,"2.5%"], 1:100, cf[,"97.5%"])
points(0:100, ihdlondon$cfout, col="purple")
legend("topright", lwd=c(1,NA), pch=c(19, 1), col=c("black","purple"), c("Bayesian posterior median and 95% interval", "DisMod II output"), bty="n")
```

The uncertainty about case fatality is biggest for the youngest and oldest ages, where either prevalence is lowest or the proportion of the cohort who are still alive is lowest. 

Agreement with the DisMod II estimates is good, except for the youngest ages, presumably because there was some additional source of information which was included in the DisMod estimates but omitted here. 



## Other things we could do 

For chronic diseases in general:

* Account for variations in incidence and prevalence with time as well as age.  DisMod II allows time trends to be modelled, but assumes that time trends are independent of age.  Relaxing this assumption would be feasible, but possibly computationally expensive. 
	* For IHD in the UK, data on time trends may come from the Health Survey for England, years 1993, 1994, 1988, 2003, 2006, 2011. 
	

* Account for variations between populations in different areas.  Hierarchical modelling might be used here - DISMOD-MR does this, I believe.

* Jointly model multiple diseases.  i.e. relaxing the assumption that mortality from causes other than the disease is the same for people with and without the disease.  Multimorbidity. 
* In general, to transparently represent uncertainty, and explicitly build in other sources of information, in situations where we suspect the data may not be representative

All of these would be theoretically feasible in the above framework. The limits will be computational, and difficult to tell before getting hands on.


# References
