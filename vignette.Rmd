---
title: "Bayesian estimation of chronic disease epidemiology from incomplete data"
output: 
  html_document:
    number_sections: true
---


# Theoretical disease model 

We represent a disease as a continuous-time, multi-state process with three states: 

1. disease-free
2. disease
3. dead from the disease.

If we assume that mortality from other causes is independent of disease status, we can ignore deaths from other causes.   Assume also that recovery from the disease is not possible, but the framework is easily extensible to handle recurrence. The disease process is then fully defined by the 

* disease incidence $i(t)$, and the 

* case fatality rate $f(t)$,

which are both assumed to depend on age $t$.  Assume further that these rates are constant within integer years of age $a$, so they can be written $i_a$, $f_a$.

From these we can determine the _transition probability matrix_ $P_a$, whose $r,s$ entry $P_{ars}$ is the probability that a person is in state $s$ at age $a+1$ given they are in state $r$ at age $a$. The matrix $P_a$ is defined in terms of $i_a$ and $f_a$ as a differential equation, whose solution is written out explicitly in the DisMod II paper. 

Further, let $sp_a$ be the proportion of individuals in a birth cohort who are in each state at age $a$.  This is a row vector with three elements $sp_{ar}$, one for each state $r$.  The transition probability matrix can then be used to obtain the corresponding proportions at age $a+1$, as 

$$ sp_{a+1} = sp_a P_a $$ 

The prevalence of disease (among people who are alive) at each age $a$ is then obtained as $pr_a = sp_{a2} / (sp_{a1} + sp_{a2})$. 

The disease-specific mortality rate at age $a$, or the probability that a person alive at age $a$ dies from the disease before age $a+1$, can also be expressed in terms of the transition probabilities and prevalence, as 

$$ dm_a = P_{a23} pr_a + P_{a13} (1 - pr_a) $$


# Bayesian approach to estimating the model from data

Data are observed which give information about some, but not all, of the parameters in the theoretical disease model.   The form of the data available may be different in each application.  We then wish to estimate any remaining unknown parameters.   The Bayesian approach to estimating these unknowns can be described as four steps:

1. write down a theoretical model for underlying disease progression (as done above)

2. write down a statistical model for the observed data given the parameters of the underlying disease model.  An example of this is illustrated below.

3. write down prior distributions for the unknowns.  These may express prior ignorance, as in the example below.

4. compute the (unique) posterior distribution of the unknown parameters in the joint model, given the observed data.  Software discussed below. 

This approach is used in the DisMod-MR software, as explained in the book by Flaxman et al, however the software itself is undocumented and not fully published.  The older (published) DisMod II used an optimisation approach to estimate parameters, which is a rough less statistically principled approximation.  Other advantages of the Bayesian method include 

* straightforward to build in multiple sources of direct/indirect data.  This is enabled by the computational methods and available software for Bayesian modelling (illustrated below).   This allows the approach to generalise to settings with different forms of data available.  In contrast, DisMod II only allows limited forms of data. 

* automatic quantification of uncertainty, given the information supplied (as illustrated below)




# Example: IHD in Greater London 

The following data are given in the example spreadsheet 

* incidence of IHD by age

* IHD-specific mortality by age

and we wish to estimate case fatality by age, given these inputs. 

TODO PLOTS AND OR TABLES OF THE INPUT DATA 

Note that these "data" are themselves estimates, based on underlying data from a finite population, that are not given.  In the Bayesian approach we can acknowledge that the incidence, mortality and/or case fatality are unknowns.   We illustrate this approach.  For simplicity, suppose that 

* the incidence $i_a$ is known and fixed at the quantities supplied in the spreadsheet, but 

* the disease-specific mortalities $dm_a$ are unknown, and have been estimated in terms of counts of individuals $n_a$ alive at age $a$ and the corresponding number $r_a$ who die of IHD before age $a+1$.

In this example, we can roughly recreate $n_a$ and $r_a$ as follows.  We are given population counts for five-year age groups, thus we obtain approximate one-year population counts $n_a$ by dividing these values by 5.  The number of IHD deaths $r_a$ is then approximately reconstructed by multiplying $n_a$ by the IHD-specific mortality rates supplied in the spreadsheet.

The four steps of the Bayesian modelling process are then be implemented as follows:

1. write down the theoretical disease model, as given above

2. write down the statistical model for the data.  This is $r_a \sim ~ Binomial(n_a, dm_a)$, that is, $r_a$ is assumed to have arisen from a Binomial distribution with denominator $n_a$ and probability $dm_a$, which is a deterministic function of the incidences and case fatalities $\{i_a,f_a\}$ up to age $a$, as described in the theoretical disease model. 

3. define prior distributions for the unknown parameters.  For example, for each case fatality rate $f_a$, we assume a uniform distribution between 0 and 0.1.  Sensitivity to this should be assessed.  With enough data, the prior distribution will not matter.

4. compute the posterior distribution $p(\theta | \mathbf{y})$ for parameters $\theta = \{f_a\}$ given data $\mathbf{y} = \{i_a, r_a, n_a\}$


## Software for Bayesian computation 

The Stan software ([mc-stan.org](http://mc-stan.org)) allows any Bayesian model to be written down in the Stan language.  The software then enables a sample from the posterior distribution to be drawn, using Hamiltonian Monte Carlo sampling.   It has an R interface, through the `rstan` package. 

In this example, the theoretical disease model, statistical model and priors are written down in Stan language (link to Stan file on github)

The data $\mathbf{y} = \{i_a, r_a, n_a\}$ are supplied through R 

(example of R code. data supplied in R data frame) 


## Results 


Posterior distribution for case fatality, overlay dismod outputs 

Posterior for prevalence, disease-specific mortality 

Load the Stan package, after installing it into R if necessary with `install.packages("rstan")`. 
```{r}
library(rstan)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
```

Load the IHD London dataset, put it in required format for Stan, and define initial values for 4 parallel MCMC simulations.   Finally, run the simulation with `stan()`, which should take less than a minute. 
```{r}
load(file="ihdlondon.rda")
datstan <- c(as.list(ihdlondon), nage=nrow(ihdlondon))
inits <- list(
    list(cf=rep(0.0101, datstan$nage)),
    list(cf=rep(0.0201, datstan$nage)),
    list(cf=rep(0.0056, datstan$nage)),
    list(cf=rep(0.0071, datstan$nage))
)
gbdcf <- stan("gbdcf-unsmoothed.stan", data=datstan, init=inits)
```

Check the MCMC simulations from the posteriors for six selected parameters has converged.  The four simulation chains should mix together and look like white noise.

```{r}
traceplot(gbdcf, pars=paste0("cf[", 60:65, "]"))
```

Extract all summary statistics (posterior median, 95% credible intervals, etc)
```{r}
summ <- summary(gbdcf)$summary
```

Extract and plot summary statistics for case fatality, and overlay the DisMod III estimates

```{r}
cfpars <- paste0("cf[",1:100,"]")
cf <- summ[cfpars,]
plot(1:100, cf[,"50%"], ylim=c(0, 0.1), pch=19, ylab="Estimated case fatality rate", xlab="Age")
title("Estimating case fatality given mortality and incidence data")
title("IHD, Greater London (?year?)", line=0.5)
segments(1:100, cf[,"2.5%"], 1:100, cf[,"97.5%"])
points(0:100, ihdlondon$cfout, col="purple")
legend("topright", lwd=c(1,NA), pch=c(19, 1), col=c("black","purple"), c("Bayesian posterior median and 95% interval", "DisMod II output"), bty="n")
```
