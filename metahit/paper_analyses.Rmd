---
output: html_document
editor_options: 
  chunk_output_type: console
---
Keep this nice and tidy.

```{r}

setwd("~/work/chronic/disbayes/metahit")
source("paper_analyses_header.r")
source("read_model_results.r")

```






# Data summary 

Raw point estimates of mort, inc and prev.   Just women for now.  Curves compared between areas, faceted by disease.   Shows diseases where prevalence and incidence are very low.  Mild differences between areas.    

```{r,eval=FALSE}

source("paper_analyses_header.r")
ymax_mort <- enframe(c("Ischemic heart disease"=0.2,"Stroke"=0.1,"Dementia"=0.2,
                       "COPD"=0.1, "Breast cancer"=0.03, "Lung cancer"=0.02,
                       "Colon and rectum cancer"=0.02, "Stomach cancer"=0.01, 
                       "Uterine cancer"=0.002), name="disease", value="ymax_mort")

ymax_inc <- enframe(c("Ischemic heart disease"=0.1, "Stroke"=0.1,"Dementia"=0.1,
                      "COPD"=0.1, "Breast cancer"=0.03, "Lung cancer"=0.03,
                      "Colon and rectum cancer"=0.03, "Stomach cancer"=0.01,
                      "Uterine cancer"=0.002), name="disease", value="ymax_inc")

gbdplot <- gbdplot %>%
    left_join(ymax_mort, by="disease") %>%
    left_join(ymax_inc, by="disease") %>%
    mutate(mort_upper = pmin(mort_upper, ymax_mort),
           inc_upper = pmin(inc_upper, ymax_inc),
           disease = factor(disease, levels=disease_order))
ht <- 3
pdf("../../write/mort_data.pdf", height=ht)
gbdplot$areagender <- interaction(gbdplot$area, gbdplot$gender)
ggplot(gbdplot, aes(x=age, y=mort_prob, col=area, lty=gender, group=areagender)) + 
  facet_wrap(~disease, ncol=3, scales="free_y") + 
  coord_cartesian(xlim = c(50,100)) +
  ylab("Annual mortality probability") + 
  xlab("Year of age") +
  geom_ribbon(aes(ymin=mort_lower, ymax=mort_upper), fill="gray80", col="gray80") +
  geom_line() + 
  labs(col = "City region") +
  theme_bw() + 
  theme(strip.text.x = element_text(size = 7.5),
        legend.position = "none")
dev.off()

pdf("../../write/inc_data.pdf", height=ht)
ggplot(gbdplot, aes(x=age, y=inc_prob, col=area, lty=gender, group=areagender)) + 
  facet_wrap(~disease, ncol=3, scales="free_y") + 
  coord_cartesian(xlim = c(50,100)) +
  ylab("Annual incidence probability") + 
  xlab("Year of age") +
  geom_ribbon(aes(ymin=inc_lower, ymax=inc_upper), fill="gray80", col="gray80") +
  geom_line() + 
  labs(col = "City region") +
  theme_bw() + 
  theme(strip.text.x = element_text(size = 7.5),
        legend.position = "none")
dev.off()

pdf("../../write/prev_data.pdf", height=ht)
ggplot(gbdplot, aes(x=age, y=prev_prob, col=area, lty=gender, group=areagender)) + 
  facet_wrap(~disease, ncol=3, scales="free_y") + 
  coord_cartesian(xlim = c(50,100)) +
  ylab("Prevalence probability") + 
  xlab("Year of age") +
  geom_ribbon(aes(ymin=prev_lower, ymax=prev_upper), fill="gray80", col="gray80") +
  geom_line() + 
  labs(col = "City region", lty="") +
  theme_bw() + 
  theme(strip.text.x = element_text(size = 7.5),
        legend.spacing.y = unit(0.1, "cm"))
dev.off()


```



# Independent areas 

* Results from fitting disbayes model by disease, gender and area separately

* Stomach cancer and uterine cancer are done using national data. 

```{r,eval=FALSE}

## MCMC convergence checks.   All OK with 5000 samples and the occasional model simplification
resnc <- resnh %>% filter(Rhat > 1.05)
table(resnc$disease, resnc$area, resnc$gender)


## Compare modal approximation with posterior 
## Page of plots for a single area and gender.
## Disease variation more important than area/gender variation  
## stmc, utrc use national point estimates 

resopt <- readRDS("resopt_nonhier.rds") %>% 
  filter(!disease %in% c("Stomach cancer","Uterine cancer"))
resoptnat <- readRDS("resopt_nat.rds")
resoptcf <- resopt %>%
  full_join(resoptnat) %>% 
  filter(var=="cf") %>%
  mutate(p50 = 1 - exp(-`mode`),
         plow = 1 - exp(-`2.5%`),
         pupp = 1 - exp(-`97.5%`)) %>%
  filter(area=="Bristol" | area=="England", gender=="Female") %>%
  mutate(disease = fct_recode(disease, !!!disease_shorten),
           disease = factor(disease, levels = disease_order)) %>%
  filter(age %in% c(70, 75, 80, 85, 90)) %>%
  mutate(Algorithm = "Mode approximation")

pdf("../../write/opt_compare.pdf")

resp <- resall %>% 
  dplyr::filter(model %in% c("Independent areas","National"), var=="cf") %>%
  dplyr::filter(area=="Bristol" | (area=="England" & model=="National"), gender=="Female") %>%
  mutate(Algorithm="MCMC") %>%
  full_join(resoptcf)
resp %>%
  filter(age %in% c(70, 75, 80, 85, 90)) %>%
  mutate(par = 1 - exp(-`50%`),
         plow = 1 - exp(-`2.5%`),
         pupp = 1 - exp(-`97.5%`)) %>%
  ggplot(aes(x=age, y=par, col=Algorithm, lty=Algorithm)) + 
  geom_errorbar(aes(ymin=plow, ymax=pupp), width=1.5,
              position=position_dodge(width=2), lwd=1.3) +
  geom_point(position=position_dodge(width=2), size=1.3) + 
  facet_wrap(vars(disease), ncol=2, scales="free_y") + 
  xlab("Age (years)") + ylab("Case fatality probability")

dev.off()



## Age curves for all diseases and areas 

pdf("../../write/all_cf_indep.pdf",width=6,height=6)

gg <- resall %>% 
    dplyr::filter(model %in% c("Independent areas","National"), 
                  var=="cf",
                area %in% c(cityregions,"England")) %>%
    mutate(area = forcats::fct_relevel(area, "England", after=Inf)) %>%
    dplyr::filter(! (disease=="Uterine cancer" & age > 90)) %>%
    mutate(p50 = 1 - exp(-`50%`),
         plow = 1 - exp(-`2.5%`),
         pupp = 1 - exp(-`97.5%`)) %>%
  ggplot(aes(x=age, y=p50, group=area, col=area)) + 
  geom_ribbon(aes(ymin=plow, ymax=pupp), 
              fill="gray80", col="gray80") +
  geom_line() + 
  facet_grid(cols=vars(gender), rows=vars(disease), scales = "free_y", switch = "y") + 
  xlab("Age (years)") + 
  ylab("Annual case fatality probability") + 
  xlim(60,100) + 
  theme(strip.text.y.left = element_text(angle = 0),
        strip.text.y = element_text(size=6),
        axis.text = element_text(size=8),
        legend.text = element_text(size=6)) + 
    labs(col="")

grob <- ggplotGrob(gg)
# gtable::gtable_show_layout(grob)
idx <- which(grob$layout$name %in% c("panel-5-2","panel-9-2"))
for (i in idx) grob$grobs[[i]] <- grid::nullGrob()
grid::grid.draw(grob)

dev.off()

```




# Hierarchical model

```{r,cache=TRUE}

## UTRC doesn't converge, and STMC estimates noisy, so we use national estimate results 
resnc <- resh %>% filter(Rhat > 2) 
resnc <- resh %>% filter(Rhat > 1.1) 
resnc <- resh %>% filter(Rhat > 1.05) 
table(resnc$disease, resnc$gender)

## Look at precision of CRC estimates as exemplar. 
## Effective sample size of 1000 after a few hours
resh %>% filter(gender=="Male", disease=="Ischemic heart disease", age==60, var=="cf") %>% head
resh %>% filter(gender=="Male", disease=="Colon and rectum cancer", age==60, var=="cf") %>% head



## Between area variability in age curves, point ests.  All diseases 

pdf("../../write/hier.pdf", width=6, height=4)

resall %>% 
    filter(var=="cf", !(disease %in% c("Uterine cancer" , "Stomach cancer")),
           area %in% cityregions, 
           gender=="Female",
           model %in% c("Independent areas","Hierarchical")) %>%
    mutate(disease = fct_recode(disease, 
                                "Colorectal cancer"="Colon and rectum cancer",
                                "IHD" = "Ischemic heart disease")) %>%
    mutate(p50 = 1 - exp(-`50%`),
           plow = 1 - exp(-`2.5%`),
           pupp = 1 - exp(-`97.5%`)) %>%
    mutate(model = relevel(factor(model), "Independent areas")) %>%
    ggplot(aes(x=age, col=area, group=area)) +
    geom_ribbon(aes(ymin=plow, ymax=pupp), fill="gray80", col="gray80") +
    geom_line(aes(y=p50)) + 
    coord_cartesian(xlim=c(70,  100), ylim=c(0,NA)) +
    scale_x_continuous(breaks=seq(0,100,10)) + 
    ylab("Annual case fatality probability")  +
    facet_grid(cols=vars(model), rows=vars(disease),
               scales="free_y", switch = "y") + 
    xlab("Age (years)") + 
    labs(col="") +
    theme(strip.text.y.left = element_text(angle = 0),
          strip.text.y = element_text(size = 6.5),
          legend.text = element_text(size = 6.5))

dev.off()


```




# Hierarchical model with gender effect independent of area

```{r}

resg <- resg %>% filter(disease != "Stomach cancer") # only national estimates
# convergence check
summary(resg$Rhat)  # 
resnc <- resg %>% filter(Rhat > 2) 
resnc <- resg %>% filter(Rhat > 1.1) 
resnc <- resg %>% filter(Rhat > 1.01) 
table(resnc$disease)
table(resnc$disease, resnc$area)

## Point est curves compared between areas 
## Not shown in paper
rescf <- resg %>% filter(gender=="Male", var=="cf")
rescf <- resg %>% filter(gender=="Female", var=="cf")
ggplot(rescf, aes(x=age, col=area)) +
  geom_line(aes(y=`50%`)) + 
  coord_cartesian(ylim=c(0, 1), 
                  xlim=c(50,  100)) +
  scale_x_continuous(breaks=seq(0,100,10)) + 
  ylab("Case fatality (median, 95% CrI)")  +
  facet_wrap(~disease, ncol=2) + 
  xlab("Age (years)") 

## Get curves of m/f CF risk ratios by age and area, from the hier model with 
## different gender effect for each area 
reshi <- resh %>%  
  mutate(disease = fct_recode(disease, !!!disease_shorten)) %>%
  filter(! disease %in% c("Breast cancer", 
                          "Stomach cancer", 
                          "Uterine cancer"), 
         area %in% cityregions, 
         var=="cf") %>%
  mutate(est = log(`50%`), se=(log(`97.5%`)-log(`2.5%`))/4) 
reshie <- reshi %>%
  select(age, gender, area, disease, est) %>% 
  pivot_wider(names_from=gender, values_from=est) %>%
  mutate(lhrmale = Male - Female) %>%
  select(age, area, disease, lhrmale)
reshis <- reshi %>%
  select(age, gender, area, disease, se) %>% 
  pivot_wider(names_from=gender, values_from=se) %>%
  mutate(sediff = sqrt(Male^2 + Female^2)) %>%
  select(age, area, disease, sediff) %>%
  left_join(reshie, by=c("age","area","disease")) %>%
  mutate(est = exp(lhrmale), 
         lower=exp(lhrmale - 2*sediff),
         upper=exp(lhrmale + 2*sediff))

## Superimpose the equivalent common curve from the common effect model
resgi <- resg %>%  
  filter(! disease %in% c("Breast cancer", 
                          "Stomach cancer", 
                          "Uterine cancer"), 
         area %in% cityregions, 
         var=="cf") %>%
  mutate(disease = fct_recode(disease, !!!disease_shorten)) %>%
  mutate(est = log(`50%`), se=(log(`97.5%`)-log(`2.5%`))/4) 
resgie <- resgi %>%
  select(age, gender, area, disease, est) %>% 
  pivot_wider(names_from=gender, values_from=est) %>%
  mutate(lhrmale = Male - Female) %>%
  select(age, area, disease, lhrmale)
resgis <- resgi %>%
  select(age, gender, area, disease, se) %>% 
  pivot_wider(names_from=gender, values_from=se) %>%
  mutate(sediff = sqrt(Male^2 + Female^2)) %>%
  select(age, area, disease, sediff) %>%
  left_join(resgie, by=c("age","area","disease")) %>%
  mutate(est = exp(lhrmale), 
         lower=exp(lhrmale - 2*sediff),
         upper=exp(lhrmale + 2*sediff))

## Put this in the paper 
## Hazard ratio for men compared to women for case fatality 
## This is good evidence that the general pattern is common among areas 

pdf("../../write/gender_hr.pdf", width=6, height=4)

ggplot(reshis %>% filter(age > 60), 
       aes(x=age, y=est, group=area, col=area)) + 
  geom_ribbon(aes(ymin=lower, ymax=upper), fill="gray", col=NA, alpha=0.2) + 
  geom_hline(yintercept = 1) +
  geom_line(lwd=0.8) +
  geom_line(data=resgis %>% filter(age>60), col="black", lty=2) +
  facet_wrap(~disease) +
  labs(col="Area") +
  coord_cartesian(ylim=c(0, 3)) + 
  ylab("Case fatality rate ratio (men/women)") +
  xlab("Age (years)") + 
    theme(legend.text = element_text(size = 6.5),
          strip.text = element_text(size = 6.5))

dev.off()


```





# Cross validatory comparison 

Full table of model comparison statistics for all 4 relevant models for the paper 

No-incidence model is best for all diseases


```{r}
looall2 <- looall %>% 
  filter(model %in% c("Independent areas",
                      "Independent areas, no incidence data",
                      "Hierarchical",
                      "Hierarchical joint gender"),
         !(disease %in% c("Uterine cancer","Stomach cancer")),
         outcome %in% c("inc","prev","mort"))

looallsum2 <- looall2 %>%
  filter(outcome %in% c("prev","mort")) %>% 
  group_by(age, area, gender, disease, model) %>%
  summarise(looic = sum(looic), .groups="drop") %>%
  mutate(outcome = "prevmort")
looallsum3 <- looall2 %>%
  group_by(age, area, gender, disease, model) %>%
  summarise(looic = sum(looic), .groups="drop") %>%
  mutate(outcome = "total")

lootab <- looall2 %>%
  full_join(looallsum2) %>%
  full_join(looallsum3) %>%
  select(outcome, area, age, gender, disease, model, looic) %>%
  pivot_wider(names_from=model, values_from=looic) %>%
  group_by(disease, outcome) %>%
  summarise(enh = sum(`Independent areas`),
            enhi = sum(`Independent areas, no incidence data`),
            eh = sum(`Hierarchical`),
            ehg = sum(`Hierarchical joint gender`), .groups=c("drop")) %>%
  mutate(enhi = ifelse(outcome %in% c("inc","total"), NA, enhi),
         disease = ifelse(outcome=="total", "", as.character(disease)),
         outcome = fct_recode(outcome, "Incidence"="inc", "Prevalence"="prev", 
                              "Mortality"="mort", "Prevalence and mortality" = "prevmort",
                              "Incidence, prevalence and mortality" ="total")) %>% 
  filter(outcome %in% c("Prevalence and mortality","Incidence, prevalence and mortality")) %>%
  mutate(across(3:6, ~ replace_na(as.character(round(.x)),"")))

lootab
write.table(lootab, row.names = FALSE, sep="  &  ", eol="\\\\\n", quote=FALSE)

```

